name: Process Submission

# Security: Only triggers when 'approved' label is added
# Since only collaborators can add labels, this prevents unsolicited commits
on:
  issues:
    types: [labeled]

permissions:
  contents: write
  issues: write
  pages: write
  id-token: write

jobs:
  process:
    runs-on: ubuntu-latest
    # Only process when 'approved' label is added (collaborator-only action)
    if: github.event.label.name == 'approved'

    steps:
      - name: Checkout
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Install mise
        uses: jdx/mise-action@7b911b9999162960b3b0eff7940cbc19ce5dc921 # v2.1.11

      - name: Install dependencies
        run: uv sync

      - name: Download submission JSON
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          ISSUE_BODY=$(gh api repos/${{ github.repository }}/issues/${{ github.event.issue.number }} --jq '.body')
          JSON_URL=$(echo "$ISSUE_BODY" | grep -oE 'https://github\.com/user-attachments/files/[0-9]+/[^)]+\.json' | head -1)

          if [ -z "$JSON_URL" ]; then
            gh issue comment ${{ github.event.issue.number }} -b "No JSON attachment found. Please attach a .json file from the submission form."
            exit 1
          fi

          curl -L -o submission.json "$JSON_URL"

      - name: Import submission
        id: import
        run: uv run python scripts/import_submission.py submission.json

      - name: Install system dependencies
        run: mise run setup-ci

      - name: Build
        run: mise run build

      - name: Upload build artifact
        uses: actions/upload-pages-artifact@7b1f4a764d45c48632c6b24a0339c27f5614fb0b # v4.0.0
        with:
          path: public/

      - name: Commit and push
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add -A
          git commit -m "${{ steps.import.outputs.commit_msg }}"
          git push

      - name: Deploy to GitHub Pages
        uses: actions/deploy-pages@d6db90164ac5ed86f2b6aed7e0febac5b3c0c03e # v4.0.5

      - name: Comment and close issue
        if: success()
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          COMMIT_SHA=$(git rev-parse HEAD)
          SHORT_SHA=$(git rev-parse --short HEAD)
          gh issue comment ${{ github.event.issue.number }} -b "Deployed: [\`$SHORT_SHA\`](https://github.com/${{ github.repository }}/commit/$COMMIT_SHA)

          Company page: https://wagov-dtt.github.io/defencewest-site/company/${{ steps.import.outputs.slug }}/"
          gh issue close ${{ github.event.issue.number }}

      - name: Comment failure
        if: failure()
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh issue comment ${{ github.event.issue.number }} -b "Submission import failed. Please check the JSON file and try again, or contact the team for assistance."
