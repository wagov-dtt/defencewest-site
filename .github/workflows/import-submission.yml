name: Import Submission

on:
  workflow_dispatch:
    inputs:
      s3_key:
        description: 'S3 object key (e.g., sub-1234567890-company-name.json)'
        required: true
        type: string
      reviewer:
        description: 'GitHub username to assign as reviewer (optional)'
        required: false
        type: string

env:
  AWS_REGION: ap-southeast-2
  S3_BUCKET: ${{ vars.S3_SUBMISSIONS_BUCKET }}

jobs:
  import:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
      id-token: write  # For OIDC auth to AWS

    steps:
      - uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ vars.AWS_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Download submission from S3
        run: |
          aws s3 cp "s3://${S3_BUCKET}/${{ inputs.s3_key }}" submission.json

      - name: Install mise
        uses: jdx/mise-action@v2

      - name: Install dependencies
        run: uv sync

      - name: Import submission
        id: import
        run: |
          uv run python scripts/import_submission.py submission.json

      - name: Create Pull Request
        uses: peter-evans/create-pull-request@v7
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "${{ steps.import.outputs.commit_msg }}"
          branch: "submission/${{ steps.import.outputs.slug }}"
          delete-branch: true
          title: "${{ steps.import.outputs.pr_title }}"
          body: |
            ## Submission Details

            **Company:** ${{ steps.import.outputs.company_name }}
            **Type:** ${{ steps.import.outputs.submission_type }}
            **Source:** `${{ inputs.s3_key }}`

            ${{ steps.import.outputs.warnings }}

            ---

            ### Checklist
            - [ ] Company name is accurate
            - [ ] Contact information verified
            - [ ] Logo is appropriate (if included)
            - [ ] Taxonomies are correct
            - [ ] No duplicate entry exists
          reviewers: ${{ inputs.reviewer }}
          labels: submission

      - name: Archive processed submission
        if: success()
        run: |
          aws s3 mv "s3://${S3_BUCKET}/${{ inputs.s3_key }}" "s3://${S3_BUCKET}/processed/${{ inputs.s3_key }}"
