{{/* Filters partial - shared between directory and map pages
  Expects: $companies, $taxonomies, $site (for .Site.Taxonomies)
  
  All filters use single param "f" with prefix:value format:
  - stake:xxx = stakeholder
  - stream:xxx = capability stream
  - domain:xxx = capability domain
  - ind:xxx = industrial capability
  - region:xxx = region
  - own:xxx = ownership
  
  Taxonomy structure: { key: "Full Name" }
  Company frontmatter stores keys, not display names.
  Icons are at /icons/streams/{key}.png and /icons/ownerships/{key}.png
  
  Uses Hugo's native .Site.Taxonomies for counts instead of manual iteration.
*/}}
{{- $companies := .companies -}}
{{- $taxonomies := .taxonomies -}}
{{- $site := .site -}}

{{/* Use Hugo's native taxonomy counts */}}
{{- $stakeholderCounts := $site.Taxonomies.stakeholders -}}
{{- $streamCounts := $site.Taxonomies.capability_streams -}}
{{- $domainCounts := $site.Taxonomies.capability_domains -}}
{{- $industrialCounts := $site.Taxonomies.industrial_capabilities -}}
{{- $regionCounts := $site.Taxonomies.regions -}}

{{/* Ownership counts - still manual since these are boolean flags, not taxonomies */}}
{{- $indigenousCount := 0 -}}
{{- $veteranCount := 0 -}}
{{- range $companies -}}
  {{- if .is_indigenous_owned }}{{ $indigenousCount = add $indigenousCount 1 }}{{ end -}}
  {{- if .is_veteran_owned }}{{ $veteranCount = add $veteranCount 1 }}{{ end -}}
{{- end -}}

<form class="filters" id="filters" method="get" action="">
  <!-- Status -->
  <div class="filter-status">
    <span><span class="visible-count">{{ len $companies }}</span> / {{ len $companies }}</span>
    <input type="text" id="filter-options" placeholder="Filter..." autocomplete="off" aria-label="Filter options">
    <button type="reset" class="clear-all outline secondary">Clear</button>
  </div>

  <!-- Stakeholders -->
  <details open>
    <summary>Stakeholders</summary>
    <div class="filter-list">
      {{- range $key, $name := $taxonomies.stakeholders -}}
        {{- $term := index $stakeholderCounts $key -}}
        {{- $count := 0 }}{{ with $term }}{{ $count = .Count }}{{ end -}}
        {{- if gt $count 0 }}
      <label class="filter-item">
        <input type="checkbox" name="f" value="stake:{{ $key }}" />
        <span class="filter-label">{{ $name }}</span>
        <span class="filter-count">{{ $count }}</span>
      </label>
        {{- end -}}
      {{- end }}
    </div>
  </details>

  <!-- Capability Streams -->
  <details open>
    <summary>Capability Streams</summary>
    <div class="stream-icons">
      {{- range $key, $name := $taxonomies.capability_streams -}}
        {{- $term := index $streamCounts $key -}}
        {{- $count := 0 }}{{ with $term }}{{ $count = .Count }}{{ end -}}
        {{- if gt $count 0 }}
      <label class="stream-icon" title="{{ $name }} ({{ $count }})">
        <input type="checkbox" name="f" value="stream:{{ $key }}" />
        <img src="{{ printf "icons/streams/%s.png" $key | relURL }}" alt="{{ $name }}" />
      </label>
        {{- end -}}
      {{- end }}
    </div>
  </details>

  <!-- Capability Domains -->
  <details>
    <summary>Domains</summary>
    <div class="filter-list">
      {{- range $key, $name := $taxonomies.capability_domains -}}
        {{- $term := index $domainCounts $key -}}
        {{- $count := 0 }}{{ with $term }}{{ $count = .Count }}{{ end -}}
        {{- if gt $count 0 }}
      <label class="filter-item">
        <input type="checkbox" name="f" value="domain:{{ $key }}" />
        <span class="filter-label">{{ $name }}</span>
        <span class="filter-count">{{ $count }}</span>
      </label>
        {{- end -}}
      {{- end }}
    </div>
  </details>

  <!-- Industrial Capabilities -->
  <details>
    <summary>Industrial</summary>
    <div class="filter-list">
      {{- range $key, $name := $taxonomies.industrial_capabilities -}}
        {{- $term := index $industrialCounts $key -}}
        {{- $count := 0 }}{{ with $term }}{{ $count = .Count }}{{ end -}}
        {{- if gt $count 0 }}
      <label class="filter-item">
        <input type="checkbox" name="f" value="ind:{{ $key }}" />
        <span class="filter-label">{{ $name }}</span>
        <span class="filter-count">{{ $count }}</span>
      </label>
        {{- end -}}
      {{- end }}
    </div>
  </details>

  <!-- Regions -->
  <details>
    <summary>Regions</summary>
    <div class="filter-list">
      {{- range $key, $name := $taxonomies.regions -}}
        {{- $term := index $regionCounts $key -}}
        {{- $count := 0 }}{{ with $term }}{{ $count = .Count }}{{ end -}}
        {{- if gt $count 0 }}
      <label class="filter-item">
        <input type="checkbox" name="f" value="region:{{ $key }}" />
        <span class="filter-label">{{ $name }}</span>
        <span class="filter-count">{{ $count }}</span>
      </label>
        {{- end -}}
      {{- end }}
    </div>
  </details>

  <!-- Ownership -->
  {{- with $taxonomies.ownerships }}
  <details open>
    <summary>Ownership</summary>
    <div class="stream-icons">
      {{- range $key, $name := . -}}
        {{- $count := 0 -}}
        {{- if eq $key "indigenous" }}{{ $count = $indigenousCount }}{{ end -}}
        {{- if eq $key "veteran" }}{{ $count = $veteranCount }}{{ end -}}
        {{- if gt $count 0 }}
      <label class="stream-icon" title="{{ $name }} ({{ $count }})">
        <input type="checkbox" name="f" value="own:{{ $key }}" />
        <img src="{{ printf "icons/ownerships/%s.png" $key | relURL }}" alt="{{ $name }}" />
      </label>
        {{- end -}}
      {{- end }}
    </div>
  </details>
  {{- end }}
</form>
