{{/* Filters partial - shared between directory and map pages
  Expects: $companies, $taxonomies
  
  All filters use single param "f" with prefix:value format:
  - stake:xxx = stakeholder
  - stream:xxx = capability stream
  - domain:xxx = capability domain
  - ind:xxx = industrial capability
  - region:xxx = region
  - own:xxx = ownership
  
  Taxonomy structure: { key: "Full Name" }
  Company frontmatter stores keys, not display names.
  Icons are at /icons/streams/{key}.png and /icons/ownerships/{key}.png
*/}}
{{- $companies := .companies -}}
{{- $taxonomies := .taxonomies -}}

{{/* Count companies per taxonomy key */}}
{{- $stakeholderCounts := dict -}}
{{- $streamCounts := dict -}}
{{- $domainCounts := dict -}}
{{- $industrialCounts := dict -}}
{{- $regionCounts := dict -}}

{{- range $companies -}}
  {{- range .stakeholders -}}
    {{- $stakeholderCounts = merge $stakeholderCounts (dict . (add (index $stakeholderCounts . | default 0) 1)) -}}
  {{- end -}}
  {{- range .capability_streams -}}
    {{- $streamCounts = merge $streamCounts (dict . (add (index $streamCounts . | default 0) 1)) -}}
  {{- end -}}
  {{- range .capability_domains -}}
    {{- $domainCounts = merge $domainCounts (dict . (add (index $domainCounts . | default 0) 1)) -}}
  {{- end -}}
  {{- range .industrial_capabilities -}}
    {{- $industrialCounts = merge $industrialCounts (dict . (add (index $industrialCounts . | default 0) 1)) -}}
  {{- end -}}
  {{- range .regions -}}
    {{- $regionCounts = merge $regionCounts (dict . (add (index $regionCounts . | default 0) 1)) -}}
  {{- end -}}
{{- end -}}

{{/* Ownership counts */}}
{{- $indigenousCount := 0 -}}
{{- $veteranCount := 0 -}}
{{- range $companies -}}
  {{- if .is_indigenous_owned }}{{ $indigenousCount = add $indigenousCount 1 }}{{ end -}}
  {{- if .is_veteran_owned }}{{ $veteranCount = add $veteranCount 1 }}{{ end -}}
{{- end -}}

<form class="filters" id="filters" method="get" action="">
  <!-- Status -->
  <div class="filter-status">
    <span><span class="visible-count">{{ len $companies }}</span> / {{ len $companies }}</span>
    <input type="text" id="filter-options" placeholder="Filter..." autocomplete="off" aria-label="Filter options">
    <button type="reset" class="clear-all outline secondary">Clear</button>
  </div>

  <!-- Stakeholders -->
  <details open>
    <summary>Stakeholders</summary>
    <div class="filter-list">
      {{- range $key, $name := $taxonomies.stakeholders -}}
        {{- $count := index $stakeholderCounts $key | default 0 -}}
        {{- if gt $count 0 }}
      <label class="filter-item">
        <input type="checkbox" name="f" value="stake:{{ $key }}" />
        <span class="filter-label">{{ $name }}</span>
        <span class="filter-count">{{ $count }}</span>
      </label>
        {{- end -}}
      {{- end }}
    </div>
  </details>

  <!-- Capability Streams -->
  <details open>
    <summary>Capability Streams</summary>
    <div class="stream-icons">
      {{- range $key, $name := $taxonomies.capability_streams -}}
        {{- $count := index $streamCounts $key | default 0 -}}
        {{- if gt $count 0 }}
      <label class="stream-icon" title="{{ $name }} ({{ $count }})">
        <input type="checkbox" name="f" value="stream:{{ $key }}" />
        <img src="{{ printf "icons/streams/%s.png" $key | relURL }}" alt="{{ $name }}" />
      </label>
        {{- end -}}
      {{- end }}
    </div>
  </details>

  <!-- Capability Domains -->
  <details>
    <summary>Domains</summary>
    <div class="filter-list">
      {{- range $key, $name := $taxonomies.capability_domains -}}
        {{- $count := index $domainCounts $key | default 0 -}}
        {{- if gt $count 0 }}
      <label class="filter-item">
        <input type="checkbox" name="f" value="domain:{{ $key }}" />
        <span class="filter-label">{{ $name }}</span>
        <span class="filter-count">{{ $count }}</span>
      </label>
        {{- end -}}
      {{- end }}
    </div>
  </details>

  <!-- Industrial Capabilities -->
  <details>
    <summary>Industrial</summary>
    <div class="filter-list">
      {{- range $key, $name := $taxonomies.industrial_capabilities -}}
        {{- $count := index $industrialCounts $key | default 0 -}}
        {{- if gt $count 0 }}
      <label class="filter-item">
        <input type="checkbox" name="f" value="ind:{{ $key }}" />
        <span class="filter-label">{{ $name }}</span>
        <span class="filter-count">{{ $count }}</span>
      </label>
        {{- end -}}
      {{- end }}
    </div>
  </details>

  <!-- Regions -->
  <details>
    <summary>Regions</summary>
    <div class="filter-list">
      {{- range $key, $name := $taxonomies.regions -}}
        {{- $count := index $regionCounts $key | default 0 -}}
        {{- if gt $count 0 }}
      <label class="filter-item">
        <input type="checkbox" name="f" value="region:{{ $key }}" />
        <span class="filter-label">{{ $name }}</span>
        <span class="filter-count">{{ $count }}</span>
      </label>
        {{- end -}}
      {{- end }}
    </div>
  </details>

  <!-- Ownership -->
  {{- with $taxonomies.ownerships }}
  <details open>
    <summary>Ownership</summary>
    <div class="stream-icons">
      {{- range $key, $name := . -}}
        {{- $count := 0 -}}
        {{- if eq $key "indigenous" }}{{ $count = $indigenousCount }}{{ end -}}
        {{- if eq $key "veteran" }}{{ $count = $veteranCount }}{{ end -}}
        {{- if gt $count 0 }}
      <label class="stream-icon" title="{{ $name }} ({{ $count }})">
        <input type="checkbox" name="f" value="own:{{ $key }}" />
        <img src="{{ printf "icons/ownerships/%s.png" $key | relURL }}" alt="{{ $name }}" />
      </label>
        {{- end -}}
      {{- end }}
    </div>
  </details>
  {{- end }}
</form>
