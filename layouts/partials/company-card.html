{{/*
  COMPANY CARD COMPONENT
  
  Reusable card component demonstrating several patterns:
  
  1. Progressive Enhancement: Cards are rendered as semantic HTML with all
     content visible. JavaScript enhances with filtering, but content is
     accessible without JS.
  
  2. Data Attributes for JS: Filter data embedded in data-* attributes
     enables client-side filtering without API calls:
     - data-search: lowercase text for search matching
     - data-{taxonomy}: pipe-separated values for filter matching
  
  3. Lazy Loading: Images use loading="lazy" for performance
  
  4. Accessible Images: Logo images use empty alt="" (decorative) since
     the company name is provided as text content.
  
  Params: 
    - .company (required): company data object (frontmatter + slug)
    - .mode (optional): "directory" (default), "map", or "popup"
*/}}
{{- $company := .company -}}
{{- $mode := .mode | default "directory" -}}

{{/* Compute search text and truncated overview inline */}}
{{- $search_text := printf "%s %s" $company.name ($company.overview | default "") | lower -}}
{{- $overview_short := $company.overview | default "" | plainify | truncate 300 -}}
{{- $isMap := eq $mode "map" -}}
{{- $isPopup := eq $mode "popup" -}}
{{- $isDirectory := eq $mode "directory" -}}

{{/* Simple derivations stay in Hugo */}}
{{- $logoPath := printf "/logos/%s.png" $company.slug -}}
{{- $logoUrl := cond (fileExists (printf "static%s" $logoPath)) $logoPath "" -}}

{{- if $isPopup -}}
{{/* Popup mode: wrapped in .pico for conditional CSS */}}
<div class="pico">
  <a href="{{ printf "company/%s/" $company.slug | relURL }}" class="company-card">
    <article>
      <div class="logo-area">
        {{- if $logoUrl -}}
        <img src="{{ $logoUrl | relURL }}" alt="">
        {{- else -}}
        <span class="initials">{{ substr $company.name 0 2 | upper }}</span>
        {{- end -}}
      </div>
      <div class="name" title="{{ $company.name }}">{{ $company.name }}</div>
      <div class="badges">
        {{- if $company.is_prime }}<small>Prime</small>{{ end -}}
        {{- if $company.is_sme }}<small>SME</small>{{ end -}}
        {{- if $company.is_indigenous_owned }}<small class="highlight">Indigenous</small>{{ end -}}
        {{- if $company.is_veteran_owned }}<small class="highlight">Veteran</small>{{ end -}}
      </div>
      {{- with $overview_short }}
      <p class="overview"><small title="{{ $company.overview }}">{{ . }}</small></p>
      {{- end }}
    </article>
  </a>
</div>
{{- else -}}
{{/* Directory/Map mode: full card with wrapper and data attributes */}}
{{/* For directory mode, include column classes so filtering hides the entire column */}}
{{- $wrapperClass := cond $isMap "map-marker" "company-item col-12 col-md-4" -}}
<div class="{{ $wrapperClass }}"
     data-slug="{{ $company.slug }}"
     data-search="{{ $search_text }}"
     {{- with $company.stakeholders }} data-stakeholders="{{ delimit . "|" }}"{{ end }}
     {{- with $company.capability_streams }} data-capability_streams="{{ delimit . "|" }}"{{ end }}
     {{- with $company.capability_domains }} data-capability_domains="{{ delimit . "|" }}"{{ end }}
     {{- with $company.industrial_capabilities }} data-industrial_capabilities="{{ delimit . "|" }}"{{ end }}
     {{- with $company.regions }} data-regions="{{ delimit . "|" }}"{{ end }}
     {{- with $company.ownerships }} data-ownerships="{{ delimit . "|" }}"{{ end }}
     {{- with $company.latitude }} data-lat="{{ . }}"{{ end }}
     {{- with $company.longitude }} data-lng="{{ . }}"{{ end }}>

  {{- if $isMap }}
  <span class="marker-dot"></span>
  <div class="marker-popup">
  {{- end }}

  <a href="{{ printf "company/%s/" $company.slug | relURL }}" class="company-card{{ if $isMap }} compact{{ end }}">
    <article>
      <div class="logo-area">
        {{- if $logoUrl }}
        <img src="{{ $logoUrl | relURL }}" alt="" loading="lazy">
        {{- else }}
        <span class="initials">{{ substr $company.name 0 2 | upper }}</span>
        {{- end }}
      </div>

      <div class="name" title="{{ $company.name }}">{{ $company.name }}</div>

      <div class="badges">
        {{- if $company.is_prime }}<small>Prime</small>{{ end -}}
        {{- if $company.is_sme }}<small>SME</small>{{ end -}}
        {{- if $company.is_indigenous_owned }}<small class="highlight">Indigenous</small>{{ end -}}
        {{- if $company.is_veteran_owned }}<small class="highlight">Veteran</small>{{ end -}}
      </div>

      {{- if and $overview_short (not $isMap) }}
      <p class="overview"><small title="{{ $company.overview }}">{{ $overview_short }}</small></p>
      {{- end }}
    </article>
  </a>

  {{- if $isMap }}
  </div>
  {{- end }}
</div>
{{- end -}}
