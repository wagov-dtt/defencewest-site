{{/*
  Standalone submission page - uses PicoCSS with Squire editor and native multi-select
  Submits to S3 via API Gateway (see infra/s3-upload.yaml)
*/}}
{{- $cdn := .Site.Params.cdnUrl -}}
{{- $submitUrl := .Site.Params.submitUrl -}}
{{- $taxonomies := .Site.Data.taxonomies -}}
{{- $picoTheme := .Site.Params.picoTheme | default "slate" -}}
<!doctype html>
<html lang="en" data-theme="light">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Submit | {{ .Site.Title }}</title>
  <link rel="icon" href="{{ "favicon.ico" | relURL }}">
  <link rel="stylesheet" href="{{ $cdn }}/@picocss/pico@2/css/pico.{{ $picoTheme }}.min.css">
  <link rel="stylesheet" href="{{ "styles.css" | relURL }}">
  <script src="{{ $cdn }}/lucide@latest/dist/umd/lucide.min.js" defer></script>
  <style>
    main.container { max-width: 900px; }
    .hidden { display: none !important; }
    .required { color: var(--pico-del-color); }
    
    /* Layout helpers */
    .row { display: grid; gap: 1rem; }
    .row.two-col { grid-template-columns: 1fr 1fr; }
    .row.three-col { grid-template-columns: 1fr 1fr 1fr; }
    .row.logo-row { grid-template-columns: 180px 1fr; align-items: start; }
    @media (max-width: 768px) {
      .row.two-col, .row.three-col, .row.logo-row { grid-template-columns: 1fr; }
    }
    
    /* Logo upload */
    .logo-upload {
      border: 2px dashed var(--pico-muted-border-color);
      border-radius: var(--pico-border-radius);
      padding: 1rem;
      text-align: center;
      min-height: 160px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
    }
    .logo-upload:hover, .logo-upload.dragover { border-color: var(--pico-primary); }
    .upload-placeholder { color: var(--pico-muted-color); }
    .upload-placeholder svg { width: 40px; height: 40px; stroke: currentColor; display: block; margin: 0 auto 0.5rem; }
    .upload-link { color: var(--pico-primary); cursor: pointer; }
    .upload-preview { position: relative; }
    .upload-preview img { max-width: 140px; max-height: 120px; object-fit: contain; }
    .remove-logo {
      position: absolute; top: -8px; right: -8px;
      width: 22px; height: 22px; padding: 0; margin: 0;
      border-radius: 50%; border: none;
      background: var(--pico-del-color); color: white;
      font-size: 14px; line-height: 1; cursor: pointer;
    }
    
    /* Checkbox row */
    .checkbox-row { display: flex; gap: 1.5rem; margin-bottom: 1rem; }
    .checkbox-row label { display: flex; align-items: center; gap: 0.4rem; margin: 0; }
    .checkbox-row input { margin: 0; }
    
    /* Address */
    .address-row { display: flex; gap: 0.5rem; }
    .address-row input { flex: 1; margin-bottom: 0; }
    .address-row button { margin-bottom: 0; width: auto; }
    #address-status { font-size: 0.85rem; margin-top: 0.25rem; }
    #address-status.success { color: var(--pico-ins-color); }
    #address-status.warning { color: var(--pico-mark-background-color); }
    #address-status.error { color: var(--pico-del-color); }
    
    /* Actions */
    .actions { display: flex; gap: 0.5rem; flex-wrap: wrap; }
    
    /* Success panel */
    .success-panel { margin-top: 1rem; }
    .submission-id { display: flex; gap: 0.5rem; align-items: center; background: var(--pico-muted-background-color); padding: 0.75rem; border-radius: var(--pico-border-radius); margin: 1rem 0; }
    .submission-id code { flex: 1; word-break: break-all; background: transparent; padding: 0; }
    
    /* Native multi-select styling */
    select[multiple] { min-height: 120px; }
    
    /* === Squire Editor === */
    .editor-wrapper {
      border: var(--pico-border-width) solid var(--pico-form-element-border-color);
      border-radius: var(--pico-border-radius);
      overflow: hidden;
    }
    .editor-wrapper:focus-within {
      border-color: var(--pico-primary);
      box-shadow: 0 0 0 var(--pico-outline-width) var(--pico-primary-focus);
    }
    .editor-toolbar {
      display: flex;
      flex-wrap: wrap;
      gap: 0.25rem;
      padding: 0.5rem;
      background: var(--pico-muted-background-color);
      border-bottom: var(--pico-border-width) solid var(--pico-form-element-border-color);
    }
    .editor-toolbar button {
      width: 2.25rem;
      height: 2.25rem;
      padding: 0;
      margin: 0;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      background: var(--pico-background-color);
      border: var(--pico-border-width) solid var(--pico-muted-border-color);
      border-radius: var(--pico-border-radius);
      color: var(--pico-color);
      cursor: pointer;
    }
    .editor-toolbar button:hover {
      background: var(--pico-primary-focus);
      border-color: var(--pico-primary);
      color: var(--pico-primary);
    }
    .editor-toolbar button.active {
      background: var(--pico-primary);
      color: var(--pico-primary-inverse);
      border-color: var(--pico-primary);
    }
    .editor-toolbar button svg { width: 1rem; height: 1rem; }
    .editor-toolbar .sep {
      width: var(--pico-border-width);
      background: var(--pico-muted-border-color);
      margin: 0.25rem 0.375rem;
      align-self: stretch;
    }
    .editor-content {
      min-height: 200px;
      padding: 1rem;
      background: var(--pico-form-element-background-color);
      color: var(--pico-color);
      outline: none;
      overflow-y: auto;
    }
    .editor-content h2 { font-size: 1.25rem; margin: 0.5em 0; }
    .editor-content h3 { font-size: 1.1rem; margin: 0.5em 0; }
    .editor-content p { margin: 0 0 0.5em; }
    .editor-content ul, .editor-content ol { padding-left: 1.5em; margin: 0.5em 0; }
    .editor-content a { color: var(--pico-primary); }
  </style>
</head>
<body>
  {{- partial "navbar.html" . -}}
  <header class="container">
    <nav aria-label="breadcrumb"><ul><li><a href="{{ "/" | relURL }}">Directory</a></li><li>Submit</li></ul></nav>
    <h1 id="page-title">Submit New Listing</h1>
    <p>Fill out the form below to submit a new company or update an existing listing.</p>
  </header>

  <main class="container">
    <form id="submit-form">
      <!-- Logo + Basic Info -->
      <div class="row logo-row">
        <div class="logo-upload" id="logo-dropzone">
          <div class="upload-placeholder" id="logo-placeholder">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5"><path stroke-linecap="round" stroke-linejoin="round" d="m2.25 15.75 5.159-5.159a2.25 2.25 0 0 1 3.182 0l5.159 5.159m-1.5-1.5 1.409-1.409a2.25 2.25 0 0 1 3.182 0l2.909 2.909m-18 3.75h16.5a1.5 1.5 0 0 0 1.5-1.5V6a1.5 1.5 0 0 0-1.5-1.5H3.75A1.5 1.5 0 0 0 2.25 6v12a1.5 1.5 0 0 0 1.5 1.5Zm10.5-11.25h.008v.008h-.008V8.25Zm.375 0a.375.375 0 1 1-.75 0 .375.375 0 0 1 .75 0Z"/></svg>
            <div>Drop logo or <label for="logo-input" class="upload-link">browse</label></div>
          </div>
          <div class="upload-preview hidden" id="logo-preview-container">
            <img id="logo-preview" alt="Logo preview" src="data:image/gif;base64,R0lGODlhAQABAAD/ACwAAAAAAQABAAACADs=">
            <button type="button" class="remove-logo" id="btn-remove-logo">&times;</button>
          </div>
          <input type="file" id="logo-input" accept="image/*" hidden>
        </div>
        <div>
          <label>Company Name <span class="required">*</span><input type="text" id="field-name" required></label>
          <label>Website<input type="url" id="field-website" placeholder="https://example.com"></label>
          <div class="checkbox-row">
            <label><input type="checkbox" id="field-is-sme"> SME</label>
            <label><input type="checkbox" id="field-is-prime"> Prime Contractor</label>
          </div>
        </div>
      </div>

      <!-- Contact + Location -->
      <div class="row two-col">
        <fieldset>
          <legend>Contact</legend>
          <div class="row two-col">
            <label>Phone<input type="tel" id="field-phone"></label>
            <label>Email<input type="email" id="field-email"></label>
          </div>
          <div class="row two-col">
            <label>Contact Name<input type="text" id="field-contact-name"></label>
            <label>Contact Title<input type="text" id="field-contact-title"></label>
          </div>
        </fieldset>
        <fieldset>
          <legend>Location</legend>
          <label>Address</label>
          <div class="address-row">
            <input type="text" id="field-address" placeholder="123 Street, Perth WA 6000">
            <button type="button" id="btn-validate-address" class="outline">Lookup</button>
          </div>
          <small id="address-status"></small>
          <div class="row two-col">
            <label>Latitude<input type="text" id="field-latitude" placeholder="-31.9505"></label>
            <label>Longitude<input type="text" id="field-longitude" placeholder="115.8605"></label>
          </div>
        </fieldset>
      </div>

      <!-- Classification -->
      <fieldset>
        <legend>Classification</legend>
        <div class="row three-col">
          <label>Capability Streams
            <select id="field-capability_streams" multiple>
              {{- range $key, $name := $taxonomies.capability_streams }}<option value="{{ $key }}">{{ $name }}</option>{{- end }}
            </select>
          </label>
          <label>Capability Domains
            <select id="field-capability_domains" multiple>
              {{- range $key, $name := $taxonomies.capability_domains }}<option value="{{ $key }}">{{ $name }}</option>{{- end }}
            </select>
          </label>
          <label>Industrial Capabilities
            <select id="field-industrial_capabilities" multiple>
              {{- range $key, $name := $taxonomies.industrial_capabilities }}<option value="{{ $key }}">{{ $name }}</option>{{- end }}
            </select>
          </label>
        </div>
        <div class="row three-col">
          <label>Stakeholders
            <select id="field-stakeholders" multiple>
              {{- range $key, $name := $taxonomies.stakeholders }}<option value="{{ $key }}">{{ $name }}</option>{{- end }}
            </select>
          </label>
          <label>Regions
            <select id="field-regions" multiple>
              {{- range $key, $name := $taxonomies.regions }}<option value="{{ $key }}">{{ $name }}</option>{{- end }}
            </select>
          </label>
          <label>Ownership
            <select id="field-ownerships" multiple>
              {{- range $key, $name := $taxonomies.ownerships }}<option value="{{ $key }}">{{ $name }}</option>{{- end }}
            </select>
          </label>
        </div>
      </fieldset>

      <!-- Description -->
      <fieldset>
        <legend>Company Description</legend>
        <div class="editor-wrapper">
          <div class="editor-toolbar">
            <button type="button" data-action="h2" title="Heading 2"><i data-lucide="heading-2"></i></button>
            <button type="button" data-action="h3" title="Heading 3"><i data-lucide="heading-3"></i></button>
            <div class="sep"></div>
            <button type="button" data-action="bold" title="Bold"><i data-lucide="bold"></i></button>
            <button type="button" data-action="italic" title="Italic"><i data-lucide="italic"></i></button>
            <div class="sep"></div>
            <button type="button" data-action="ul" title="Bullet List"><i data-lucide="list"></i></button>
            <button type="button" data-action="ol" title="Numbered List"><i data-lucide="list-ordered"></i></button>
            <div class="sep"></div>
            <button type="button" data-action="link" title="Add Link"><i data-lucide="link"></i></button>
            <button type="button" data-action="unlink" title="Remove Link"><i data-lucide="unlink"></i></button>
          </div>
          <div id="editor" class="editor-content"></div>
        </div>
      </fieldset>

      <!-- Actions -->
      <div class="actions" id="form-actions">
        <button type="button" id="btn-submit">Submit to Directory</button>
        <button type="button" id="btn-copy-json" class="outline">Copy JSON</button>
      </div>

      <!-- Success -->
      <article id="success-panel" class="success-panel hidden">
        <header>Submission Received</header>
        <p>Your submission has been uploaded. Reference ID:</p>
        <div class="submission-id">
          <code id="submission-id"></code>
        </div>
        <footer class="actions">
          <button type="button" id="btn-send-email">Notify Admin via Email</button>
          <button type="button" id="btn-new-submission" class="outline">Submit Another</button>
        </footer>
      </article>
    </form>
  </main>

  <script type="module">
  import Squire from 'https://esm.sh/squire-rte@2';
  import DOMPurify from 'https://esm.sh/dompurify@3';
  import { marked } from 'https://esm.sh/marked@17';

  const CONFIG = {
    submitUrl: '{{ $submitUrl }}',
    adminEmail: 'defencewest@dpc.wa.gov.au',
    companiesUrl: '../companies.json'
  };

  const TAXONOMIES = ['capability_streams', 'capability_domains', 'industrial_capabilities', 'stakeholders', 'regions', 'ownerships'];
  const $ = id => document.getElementById(id);
  let companies = {}, editor = null, logoBase64 = null, editSlug = null;

  async function loadCompanies() {
    try { const list = await (await fetch(CONFIG.companiesUrl)).json(); list.forEach(c => { companies[c.slug] = c; }); }
    catch (e) { console.warn('Could not load companies:', e); }
  }

  function getTaxonomyValues() {
    const result = {};
    TAXONOMIES.forEach(t => {
      const select = $(`field-${t}`);
      result[t] = [...select.selectedOptions].map(o => o.value);
    });
    return result;
  }

  function setTaxonomyValues(data) {
    TAXONOMIES.forEach(t => {
      const select = $(`field-${t}`);
      const values = data[t] || [];
      [...select.options].forEach(o => { o.selected = values.includes(o.value); });
    });
  }

  function initEditor() {
    editor = new Squire($('editor'), {
      blockTag: 'P',
      sanitizeToDOMFragment: (html) => {
        const clean = DOMPurify.sanitize(html, { RETURN_DOM_FRAGMENT: true, RETURN_DOM_IMPORT: true });
        return document.importNode(clean, true);
      }
    });
    editor.setHTML('<h2>Overview</h2><p><br></p>');

    // Toolbar handlers
    document.querySelector('.editor-toolbar').addEventListener('click', e => {
      const btn = e.target.closest('button');
      if (!btn) return;
      const action = btn.dataset.action;
      const path = editor.getPath();
      switch (action) {
        case 'h2':
          if (path.includes('H2')) editor.modifyBlocks(frag => { frag.querySelectorAll('h2').forEach(el => { const p = document.createElement('p'); p.innerHTML = el.innerHTML; el.replaceWith(p); }); return frag; });
          else editor.modifyBlocks(frag => { frag.querySelectorAll('p, div, h3').forEach(el => { const h = document.createElement('h2'); h.innerHTML = el.innerHTML; el.replaceWith(h); }); return frag; });
          break;
        case 'h3':
          if (path.includes('H3')) editor.modifyBlocks(frag => { frag.querySelectorAll('h3').forEach(el => { const p = document.createElement('p'); p.innerHTML = el.innerHTML; el.replaceWith(p); }); return frag; });
          else editor.modifyBlocks(frag => { frag.querySelectorAll('p, div, h2').forEach(el => { const h = document.createElement('h3'); h.innerHTML = el.innerHTML; el.replaceWith(h); }); return frag; });
          break;
        case 'bold': editor.bold(); break;
        case 'italic': editor.italic(); break;
        case 'ul':
          if (path.includes('UL')) editor.removeList();
          else editor.makeUnorderedList();
          break;
        case 'ol':
          if (path.includes('OL')) editor.removeList();
          else editor.makeOrderedList();
          break;
        case 'link':
          const url = prompt('Enter URL:', 'https://');
          if (url) editor.makeLink(url);
          break;
        case 'unlink': editor.removeLink(); break;
      }
      editor.focus();
    });
  }

  function initLogoUpload() {
    const dropzone = $('logo-dropzone'), input = $('logo-input'), placeholder = $('logo-placeholder'), previewContainer = $('logo-preview-container'), preview = $('logo-preview');
    function handleFile(file) {
      if (!file?.type.startsWith('image/')) return;
      const reader = new FileReader();
      reader.onload = e => {
        const img = new Image();
        img.onload = () => {
          const canvas = document.createElement('canvas'), maxSize = 400;
          let { width, height } = img;
          if (width > maxSize || height > maxSize) { const s = maxSize / Math.max(width, height); width *= s; height *= s; }
          canvas.width = width; canvas.height = height;
          canvas.getContext('2d').drawImage(img, 0, 0, width, height);
          logoBase64 = canvas.toDataURL('image/png');
          preview.src = logoBase64;
          placeholder.classList.add('hidden'); previewContainer.classList.remove('hidden');
        };
        img.src = e.target.result;
      };
      reader.readAsDataURL(file);
    }
    dropzone.addEventListener('dragover', e => { e.preventDefault(); dropzone.classList.add('dragover'); });
    dropzone.addEventListener('dragleave', () => dropzone.classList.remove('dragover'));
    dropzone.addEventListener('drop', e => { e.preventDefault(); dropzone.classList.remove('dragover'); handleFile(e.dataTransfer.files[0]); });
    input.addEventListener('change', () => handleFile(input.files[0]));
    document.addEventListener('paste', e => { for (const item of e.clipboardData?.items || []) if (item.type.startsWith('image/')) { handleFile(item.getAsFile()); break; } });
    $('btn-remove-logo').addEventListener('click', () => { logoBase64 = null; preview.src = ''; input.value = ''; previewContainer.classList.add('hidden'); placeholder.classList.remove('hidden'); });
  }

  function initAddressValidation() {
    $('btn-validate-address').addEventListener('click', async () => {
      const address = $('field-address').value.trim(), status = $('address-status'), btn = $('btn-validate-address');
      if (!address) { status.textContent = 'Enter an address'; return; }
      btn.disabled = true; btn.setAttribute('aria-busy', 'true'); status.textContent = 'Looking up...';
      try {
        const query = /\b(Australia|WA)\b/i.test(address) ? address : `${address}, WA, Australia`;
        const params = new URLSearchParams({ SingleLine: query, f: 'json', maxLocations: '1', outFields: 'Addr_type,Region' });
        const res = await fetch(`https://geocode.arcgis.com/arcgis/rest/services/World/GeocodeServer/findAddressCandidates?${params}`);
        const data = await res.json();
        const c = data.candidates?.[0];
        if (c && c.location) {
          $('field-latitude').value = c.location.y.toFixed(6);
          $('field-longitude').value = c.location.x.toFixed(6);
          const isWA = /Western Australia|WA/i.test(c.attributes?.Region || c.address || '');
          const addrType = c.attributes?.Addr_type || 'Address';
          if (isWA) {
            status.textContent = `Found (${addrType}): ${c.address}`;
            status.className = 'success';
          } else {
            status.textContent = `Found but may not be in WA: ${c.address}`;
            status.className = 'warning';
          }
        } else { status.textContent = 'Address not found'; status.className = 'warning'; }
      } catch { status.textContent = 'Lookup failed'; status.className = 'error'; }
      finally { btn.disabled = false; btn.removeAttribute('aria-busy'); }
    });
  }

  const getValue = id => $(id)?.value?.trim() || '';
  const getChecked = id => $(id)?.checked || false;

  function buildSubmission() {
    const taxonomies = getTaxonomyValues();
    return {
      type: editSlug ? 'update' : 'new',
      slug: editSlug || getValue('field-name').toLowerCase().replace(/[^a-z0-9]+/g, '-').slice(0, 50),
      company: { name: getValue('field-name'), website: getValue('field-website'), phone: getValue('field-phone'), email: getValue('field-email'), address: getValue('field-address'), latitude: getValue('field-latitude'), longitude: getValue('field-longitude'), contact_name: getValue('field-contact-name'), contact_title: getValue('field-contact-title'), is_sme: getChecked('field-is-sme'), is_prime: getChecked('field-is-prime'), ...taxonomies },
      content_html: editor.getHTML(), logo: logoBase64, submitted_at: new Date().toISOString()
    };
  }

  async function submitToS3(submission) {
    const filename = `sub-${Date.now()}-${submission.slug}.json`;
    const res = await fetch(CONFIG.submitUrl + filename, {
      method: 'PUT',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(submission)
    });
    if (!res.ok) throw new Error(`Upload failed: ${res.status}`);
    return filename;
  }

  function initEditMode() {
    editSlug = new URLSearchParams(location.search).get('edit');
    if (!editSlug || !companies[editSlug]) return;
    const d = companies[editSlug];
    $('page-title').textContent = `Update: ${d.name}`;
    $('field-name').value = d.name || ''; $('field-website').value = d.website || '';
    $('field-phone').value = d.phone || ''; $('field-email').value = d.email || '';
    $('field-address').value = d.address || ''; $('field-latitude').value = d.latitude || ''; $('field-longitude').value = d.longitude || '';
    $('field-contact-name').value = d.contact_name || ''; $('field-contact-title').value = d.contact_title || '';
    $('field-is-sme').checked = d.is_sme || false; $('field-is-prime').checked = d.is_prime || false;
    setTaxonomyValues(d);
    if (d.markdown) editor.setHTML(marked.parse(d.markdown));
    const img = new Image(); img.onload = () => { $('logo-preview').src = img.src; $('logo-placeholder').classList.add('hidden'); $('logo-preview-container').classList.remove('hidden'); };
    img.src = `{{ "logos/" | relURL }}${editSlug}.png`;
  }

  function initEventHandlers() {
    let submissionId = null, submission = null;
    
    // Disable submit if not configured
    if (!CONFIG.submitUrl) {
      $('btn-submit').disabled = true;
      $('btn-submit').textContent = 'Submissions disabled';
    }
    
    $('btn-submit').addEventListener('click', async () => {
      if (!CONFIG.submitUrl) return;
      if (!getValue('field-name')) { alert('Enter a company name'); $('field-name').focus(); return; }
      const btn = $('btn-submit'); btn.disabled = true; btn.setAttribute('aria-busy', 'true');
      try {
        submission = buildSubmission();
        submissionId = await submitToS3(submission);
        $('form-actions').classList.add('hidden');
        $('success-panel').classList.remove('hidden');
        $('submission-id').textContent = submissionId;
      }
      catch (e) { alert('Error: ' + e.message); }
      finally { btn.disabled = false; btn.removeAttribute('aria-busy'); }
    });
    
    $('btn-copy-json').addEventListener('click', () => {
      const json = JSON.stringify(buildSubmission(), null, 2);
      navigator.clipboard.writeText(json);
      const b = $('btn-copy-json'); b.textContent = 'Copied!'; setTimeout(() => b.textContent = 'Copy JSON', 1500);
    });
    
    $('btn-send-email').addEventListener('click', () => {
      if (!submission) return;
      const n = submission.company.name, isNew = submission.type === 'new';
      location.href = `mailto:${CONFIG.adminEmail}?subject=${encodeURIComponent(`[DefenceWest] ${isNew?'New':'Update'}: ${n}`)}&body=${encodeURIComponent(`${isNew?'New listing':'Update'}: ${n}\n\nSubmission ID: ${submissionId}`)}`;
    });
    
    $('btn-new-submission').addEventListener('click', () => location.href = location.pathname);
  }

  // Initialize
  await loadCompanies();
  initEditor();
  initEditMode();
  initLogoUpload();
  initAddressValidation();
  initEventHandlers();
  lucide.createIcons();
  </script>
</body>
</html>
