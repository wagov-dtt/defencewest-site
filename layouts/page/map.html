{{/*
  Standalone map embed - loaded in iframe
  Uses PicoCSS conditional for popup styling
*/}}
{{- $picoTheme := .Site.Params.picoTheme -}}
{{- $cdn := .Site.Params.cdnUrl -}}
{{- $mapStyleUrl := .Site.Params.mapStyleUrl -}}
<!DOCTYPE html>
<html lang="en" data-theme="light">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Map</title>
  <base target="_top">
  <link rel="stylesheet" href="{{ $cdn }}/maplibre-gl@5/dist/maplibre-gl.css">
  <link rel="stylesheet" href="{{ $cdn }}/@picocss/pico@2/css/pico.conditional.{{ $picoTheme }}.min.css">
  <link rel="stylesheet" href="{{ "styles.css" | relURL }}">
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    html, body, #map { width: 100%; height: 100%; }
    
    /* Custom marker dot */
    .marker-dot {
      width: 14px;
      height: 14px;
      background: #1095c1;
      border: 2px solid white;
      border-radius: 50%;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
      cursor: pointer;
      transition: transform 0.15s;
    }
    .marker-dot:hover {
      transform: scale(1.3);
    }
    
    /* Larger markers on touch devices */
    @media (pointer: coarse) {
      .marker-dot {
        width: 24px;
        height: 24px;
        border-width: 3px;
      }
    }
    
    /* Popup styling */
    .maplibregl-popup-content {
      padding: 0;
      border-radius: var(--pico-border-radius);
      overflow: hidden;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
    }
    
    .maplibregl-popup-content article {
      box-shadow: none;
      margin: 0;
    }
    
    .maplibregl-popup-content p,
    .maplibregl-popup-content small {
      margin: 0;
    }
    
    /* No results overlay */
    .no-results {
      display: none;
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: white;
      padding: 1rem 2rem;
      border-radius: 6px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
      font-family: system-ui, sans-serif;
      color: #666;
      z-index: 10;
    }
  </style>
</head>
<body>
  <div id="map"></div>
  <p class="no-results">No companies match your filters.</p>
  <!-- Announce selected company to screen readers (a11y) -->
  <div id="map-status" class="visually-hidden" aria-live="polite" aria-atomic="true"></div>



  <script src="{{ $cdn }}/maplibre-gl@5/dist/maplibre-gl.js"></script>
  <script>var TAXONOMIES = {{ .Site.Params.taxonomyOrder | jsonify | safeJS }};</script>
  <script src="{{ "filter-utils.js" | relURL }}"></script>
  <script>
  (async function() {
    "use strict";

    const PERTH = [115.8605, -31.9505];
    const MAP_STYLE = "{{ $mapStyleUrl }}";
    const TYPE_LABELS = {
      "sme": "SME", "prime": "Prime", "large-enterprise": "Large Enterprise",
      "government": "Government", "educational": "Educational", "research": "Research"
    };

    async function loadCompanies() {
      const res = await fetch("{{ "companies.json" | relURL }}");
      const companies = await res.json();
      companies.forEach(c => {
        TAXONOMIES.forEach(tax => { c[tax] = (c[tax] || []).join("|"); });
      });
      return companies;
    }

    function popupHTML(c) {
      const logo = c.logo_url
        ? `<img src="${c.logo_url}" alt="">`
        : `<span class="initials">${c.name.slice(0,2).toUpperCase()}</span>`;
      const types = (c.company_types || "").split("|").filter(Boolean);
      const badges = types.map(t => `<small>${TYPE_LABELS[t] || t}</small>`).join("");
      const indigenous = (c.ownerships || "").includes("indigenous")
        ? `<small class="highlight">Indigenous</small>` : "";
      const veteran = (c.ownerships || "").includes("veteran")
        ? `<small class="highlight">Veteran</small>` : "";
      const overview = c.overview_short
        ? `<p class="overview"><small title="${c.overview || ""}">${c.overview_short}</small></p>` : "";
      return `<div class="pico"><a href="../company/${c.slug}/" class="company-card"><article>
        <div class="logo-area">${logo}</div>
        <div class="name">${c.name}</div>
        <div class="badges">${badges}${indigenous}${veteran}</div>
        ${overview}
      </article></a></div>`;
    }

    const companies = await loadCompanies();

    const map = new maplibregl.Map({
      container: "map",
      style: MAP_STYLE,
      center: PERTH,
      zoom: 4,
    });

    map.on("style.load", () => {
      map.setProjection({ type: "globe" });
    });

    map.addControl(new maplibregl.NavigationControl({
      showZoom: true,
      showCompass: true,
      visualizePitch: true
    }), 'top-right');

    const noResults = document.querySelector(".no-results");
    const mapStatus = document.getElementById("map-status");
    const markers = [];

    function announceSelection(name) {
      if (mapStatus) mapStatus.textContent = "Selected: " + name;
    }

    let activePopup = null;

    companies.forEach(c => {
      if (!c.latitude || !c.longitude) return;

      const dot = document.createElement("div");
      dot.className = "marker-dot";

      const popup = new maplibregl.Popup({ offset: 10, closeButton: false })
        .setHTML(popupHTML(c));

      const marker = new maplibregl.Marker({ element: dot })
        .setLngLat([c.longitude, c.latitude])
        .setPopup(popup)
        .addTo(map);

      dot.addEventListener("mouseenter", () => {
        if (activePopup && activePopup !== popup) activePopup.remove();
        if (!popup.isOpen()) marker.togglePopup();
        activePopup = popup;
      });

      dot.addEventListener("click", (e) => {
        e.stopPropagation();
        if (activePopup && activePopup !== popup) activePopup.remove();
        if (!popup.isOpen()) marker.togglePopup();
        activePopup = popup;
        const nameEl = popup.getElement()?.querySelector(".name");
        if (nameEl) announceSelection(nameEl.textContent);
      });

      markers.push({ marker, data: c });
    });

    document.getElementById("map").addEventListener("mouseleave", () => {
      if (activePopup) {
        activePopup.remove();
        activePopup = null;
      }
    });

    map.on("click", (e) => {
      const target = e.originalEvent.target;
      if (target.classList.contains("marker-dot")) return;
      if (activePopup) {
        activePopup.remove();
        activePopup = null;
      }
    });

    let fitBoundsTimeout = null;

    function updateMarkers() {
      const filters = getFiltersFromURL();
      let visibleCount = 0;
      const bounds = new maplibregl.LngLatBounds();

      markers.forEach(({ marker, data }) => {
        const visible = matchesFilters(data, filters);
        marker.getElement().style.display = visible ? "" : "none";
        if (visible) {
          visibleCount++;
          bounds.extend([data.longitude, data.latitude]);
        }
      });

      noResults.style.display = visibleCount === 0 ? "block" : "none";
      window.parent.postMessage({ type: "markerCount", count: visibleCount }, "*");

      clearTimeout(fitBoundsTimeout);
      if (visibleCount > 0 && visibleCount < markers.length) {
        fitBoundsTimeout = setTimeout(() => {
          map.fitBounds(bounds, { padding: 50, maxZoom: 12, duration: 500 });
        }, 300);
      }
    }

    updateMarkers();

    window.addEventListener("message", (e) => {
      if (e.origin !== window.location.origin) return;
      if (e.data?.type === "updateFilters") {
        const url = new URL(window.location);
        url.search = e.data.params;
        window.history.replaceState({}, "", url);
        updateMarkers();
      }
    });

    map.on("error", (e) => {
      console.error("Map error:", e);
    });
  })();
  </script>
</body>
</html>
