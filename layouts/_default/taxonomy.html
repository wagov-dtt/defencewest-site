{{ define "main" }}
{{/*
  Term page - lists all companies with a specific taxonomy term
  e.g., /regions/perth/ shows all companies in Perth
  Two-column layout: company cards + map embed
*/}}
{{- $taxonomies := .Site.Data.taxonomies -}}
{{- $taxonomyName := .Data.Plural -}}
{{- $termKey := .Data.Term -}}
{{- $taxonomyMap := index $taxonomies $taxonomyName -}}
{{- $displayName := index $taxonomyMap $termKey | default $termKey -}}

{{/* Display name mapping for taxonomy titles */}}
{{- $taxonomyTitles := dict 
  "capability_streams" "Capability Streams"
  "capability_domains" "Capability Domains"
  "industrial_capabilities" "Industrial Capabilities"
  "regions" "Regions"
  "stakeholders" "Stakeholders"
-}}
{{- $taxonomyTitle := index $taxonomyTitles $taxonomyName | default ($taxonomyName | humanize | title) -}}

{{/* Map taxonomy name to filter prefix */}}
{{- $filterPrefix := "" -}}
{{- if eq $taxonomyName "stakeholders" }}{{ $filterPrefix = "stake" }}{{ end -}}
{{- if eq $taxonomyName "capability_streams" }}{{ $filterPrefix = "stream" }}{{ end -}}
{{- if eq $taxonomyName "capability_domains" }}{{ $filterPrefix = "domain" }}{{ end -}}
{{- if eq $taxonomyName "industrial_capabilities" }}{{ $filterPrefix = "ind" }}{{ end -}}
{{- if eq $taxonomyName "regions" }}{{ $filterPrefix = "region" }}{{ end -}}

<nav aria-label="breadcrumb">
  <ul>
    <li><a href="{{ "/" | relURL }}">Directory</a></li>
    <li><a href="{{ printf "/%s/" $taxonomyName | relURL }}">{{ $taxonomyTitle }}</a></li>
    <li>{{ $displayName }}</li>
  </ul>
</nav>

<hgroup>
  <h1>{{ $displayName }}</h1>
  <p>
    {{ len .Pages }} {{ if eq (len .Pages) 1 }}company{{ else }}companies{{ end }}
    {{- if $filterPrefix }}
    Â· <a href="{{ printf "/?f=%s:%s" $filterPrefix $termKey | relURL }}">View with filters</a>
    {{- end }}
  </p>
</hgroup>

{{- with .Content }}{{ . }}{{ end }}

<div class="row">
  {{/* Cards column */}}
  <div class="col-6 col-m-12 col-s-12">
    <div class="grid-auto">
      {{- range .Pages.ByTitle }}
        {{- $slug := .File.BaseFileName -}}
        {{- $computed := index $.Site.Data.computed $slug -}}
        {{- $companyData := merge .Params (dict "slug" $slug) }}
        {{- partial "company-card.html" (dict "company" $companyData "computed" $computed "mode" "directory") }}
      {{- end }}
    </div>
  </div>

  {{/* Map column */}}
  <div class="col-6 col-m-12 col-s-12">
    <div class="taxonomy-map">
      <iframe src="{{ printf "map/?f=%s:%s" $filterPrefix $termKey | relURL }}" title="Map of {{ $displayName }} companies"></iframe>
    </div>
  </div>
</div>

<p><a href="{{ printf "/%s/" $taxonomyName | relURL }}">&larr; All {{ $taxonomyTitle }}</a></p>
{{ end }}
