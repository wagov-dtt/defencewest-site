{{ define "main" }}
{{/*
  Term page - lists all companies with a specific taxonomy term
  e.g., /regions/perth/ shows all companies in Perth
  Two-column layout: company cards + map embed
*/}}
{{- $taxonomies := .Site.Data.taxonomies -}}
{{- $taxonomyName := .Data.Plural -}}
{{- $termKey := .Data.Term -}}
{{- $taxonomyMap := index $taxonomies $taxonomyName -}}
{{- $displayName := index $taxonomyMap $termKey | default $termKey -}}
{{- $taxonomyTitles := .Site.Params.taxonomyTitles -}}
{{- $taxonomyTitle := index $taxonomyTitles $taxonomyName | default ($taxonomyName | humanize | title) -}}

<nav aria-label="breadcrumb">
  <ul>
    <li><a href="{{ "/" | relURL }}">Directory</a></li>
    <li><a href="{{ printf "/%s/" $taxonomyName | relURL }}">{{ $taxonomyTitle }}</a></li>
    <li>{{ $displayName }}</li>
  </ul>
</nav>

<hgroup>
  <h1>{{ $displayName }}</h1>
  <p>
    {{ len .Pages }} {{ if eq (len .Pages) 1 }}company{{ else }}companies{{ end }}
    Â· <a href="{{ printf "/?%s=%s" $taxonomyName $termKey | relURL }}">View with filters</a>
  </p>
</hgroup>

{{- with .Content }}{{ . }}{{ end }}

<div class="row">
  {{/* Cards column */}}
  <div class="col-6 col-m-12 col-s-12">
    <div class="grid-auto">
      {{- range .Pages.ByTitle }}
        {{- $slug := .File.BaseFileName -}}
        {{- $companyData := merge .Params (dict "slug" $slug) }}
        {{- partial "company-card.html" (dict "company" $companyData "mode" "directory") }}
      {{- end }}
    </div>
  </div>

  {{/* Map column */}}
  <div class="col-6 col-m-12 col-s-12">
    <div class="taxonomy-map">
      <iframe src="{{ printf "map/?%s=%s" $taxonomyName $termKey | relURL }}" title="Map of {{ $displayName }} companies"></iframe>
    </div>
  </div>
</div>

<p><a href="{{ printf "/%s/" $taxonomyName | relURL }}">&larr; All {{ $taxonomyTitle }}</a></p>
{{ end }}
