{{ define "main" }}
{{- $company := .Params -}}
{{- $slug := .File.BaseFileName -}}
{{- $taxonomies := .Site.Data.taxonomies -}}

{{/* Simple derivations stay in Hugo */}}
{{- $logoPath := printf "/logos/%s.png" $slug -}}
{{- $logoUrl := cond (fileExists (printf "static%s" $logoPath)) $logoPath "" -}}
{{- $websiteDisplay := $company.website | default "" | replaceRE "^https?://" "" | replaceRE "/$" "" -}}
{{- $mapUrl := "" -}}
{{- if and $company.latitude $company.longitude -}}
  {{- $mapUrl = printf "%s?q=%v,%v" .Site.Params.mapsUrl $company.latitude $company.longitude -}}
{{- end -}}

{{/* GitHub edit URL */}}
{{- $githubRepo := .Site.Params.githubRepo | default "example/repo" -}}
{{- $githubBranch := .Site.Params.githubBranch | default "main" -}}
{{- $githubEditUrl := printf "https://github.com/%s/edit/%s/content/company/%s.md" $githubRepo $githubBranch $slug -}}

{{/* Address search URL */}}
{{- $addressSearchUrl := "" -}}
{{- with $company.address -}}
  {{- $addressSearchUrl = printf "%s/search/?api=1&query=%s" $.Site.Params.mapsUrl (. | urlquery) -}}
{{- end -}}

<nav aria-label="breadcrumb">
  <ul>
    <li><a href="{{ "/" | relURL }}">Directory</a></li>
    <li>{{ $company.name }}</li>
  </ul>
</nav>

<div class="company-page">
  <!-- ===== VIEW MODE ===== -->
  <div id="view-mode">
    <!-- Main Content Area - Two Column Layout -->
    <div class="grid">
      <!-- Left Column: Content -->
      <div class="col-12 col-md-8 content-column">
        <h1>{{ $company.name }}</h1>
        {{- with .GetTerms "company_types" }}
        <p class="company-badges-inline">
          {{- range . }}
          {{- $displayName := index $taxonomies.company_types .Data.Term | default .LinkTitle }}
          <a href="{{ .RelPermalink }}" class="badge-link"><small>{{ $displayName }}</small></a>
          {{- end }}
        </p>
        {{- end }}
        {{ .Content }}
      </div>

      <!-- Right Column: Company Info -->
      <aside class="col-12 col-md-4 info-column">
        {{- if $logoUrl }}
        <article class="company-logo">
          <a href="{{ $company.website }}" title="{{ $company.name }}" target="_blank" rel="noopener">
            <img src="{{ $logoUrl | relURL }}" alt="{{ $company.name }}">
          </a>
        </article>
        {{- end }}

        {{- if or $company.contact_name $company.contact_title }}
        <div class="contact-person">
          {{- with $company.contact_name }}<p class="contact-name">{{ . }}</p>{{ end -}}
          {{- with $company.contact_title }}<p class="contact-title">{{ . }}</p>{{ end -}}
        </div>
        {{- end }}

        {{- if or $company.phone $company.email $company.address $company.website }}
        <div class="contact-info">
          {{- with $company.website }}<p><a href="{{ . }}" target="_blank" rel="noopener">{{ $websiteDisplay }}</a></p>{{ end -}}
          {{- with $company.phone }}<p><a href="tel:{{ . }}">{{ . }}</a></p>{{ end -}}
          {{- with $company.email }}<p><a href="mailto:{{ . }}">{{ . }}</a></p>{{ end -}}
          {{- with $company.address }}
          <p class="address">
            {{- if $addressSearchUrl }}<a href="{{ $addressSearchUrl }}" target="_blank" rel="noopener">{{ . }}</a>
            {{- else }}{{ . }}{{ end -}}
          </p>
          {{- end }}
        </div>
        {{- end }}

        {{- if and $company.latitude $company.longitude }}
        {{- $mapImage := printf "maps/%s.png" $slug }}
        {{- if fileExists (printf "static/%s" $mapImage) }}
        <div class="minimap">
          <a href="{{ $mapUrl }}" target="_blank" rel="noopener" title="View on Google Maps">
            <img src="{{ $mapImage | relURL }}" alt="Map showing {{ $company.name }} location" loading="lazy">
          </a>
        </div>
        {{- end }}
        {{- end }}

        <!-- Taxonomy Section -->
        <div class="taxonomy-section">
          {{- $hasStreams := .GetTerms "capability_streams" }}
          {{- $hasOwnerships := .GetTerms "ownerships" }}
          {{- if or $hasStreams $hasOwnerships }}
          <div class="grid taxonomy-row">
            {{- with $hasStreams }}
            {{- $taxonomies := $.Site.Data.taxonomies -}}
            <div class="taxonomy-column">
              <strong class="sidebar-section">Capability Streams</strong>
              <div class="stream-icons">
                {{- range . }}
                {{- $displayName := index $taxonomies.capability_streams .Data.Term | default .LinkTitle }}
                <a href="{{ .RelPermalink }}" title="{{ $displayName }}">
                  <img src="{{ printf "icons/streams/%s.png" .Data.Term | relURL }}" alt="{{ $displayName }}" loading="lazy">
                </a>
                {{- end }}
              </div>
            </div>
            {{- end }}
            {{- with $hasOwnerships }}
            {{- $taxonomies := $.Site.Data.taxonomies -}}
            <div class="taxonomy-column">
              <strong class="sidebar-section">Ownership</strong>
              <div class="ownership-icons">
                {{- range . }}
                {{- $displayName := index $taxonomies.ownerships .Data.Term | default .LinkTitle }}
                <a href="{{ .RelPermalink }}" title="{{ $displayName }}">
                  <img src="{{ printf "icons/ownerships/%s.png" .Data.Term | relURL }}" alt="{{ $displayName }}" loading="lazy">
                </a>
                {{- end }}
              </div>
            </div>
            {{- end }}
          </div>
          {{- end }}

          {{ partial "taxonomy-terms.html" (dict "page" . "taxonomy" "stakeholders" "title" "Stakeholders") }}
          {{ partial "taxonomy-terms.html" (dict "page" . "taxonomy" "capability_domains" "title" "Capability Domains") }}
          {{ partial "taxonomy-terms.html" (dict "page" . "taxonomy" "industrial_capabilities" "title" "Industrial Capabilities") }}
          {{ partial "taxonomy-terms.html" (dict "page" . "taxonomy" "regions" "title" "Regions") }}

          {{/* Related Companies - based on taxonomy overlap */}}
          {{- $related := .Site.RegularPages.Related . | first 5 }}
          {{- with $related }}
          <strong class="sidebar-section">Similar Companies</strong>
          <ul class="related-companies">
            {{- range . }}
            <li><a href="{{ .RelPermalink }}">{{ .Params.name }}</a></li>
            {{- end }}
          </ul>
          {{- end }}
        </div>
      </aside>
    </div>

    <!-- Footer with Edit link -->
    <footer class="company-footer">
      <a href="{{ "/submit/" | relURL }}?edit={{ $slug }}">Suggest an update</a>
    </footer>
  </div>
</div>

{{ end }}
