{{ define "main" }} {{/* Load all company pages and computed data */}} {{-
$computed := .Site.Data.computed -}} {{- $companies := slice -}} {{- range where
.Site.RegularPages "Section" "company" -}} {{- if ne .File.BaseFileName "_template" -}}
{{- $company := .Params -}} {{-
$company = merge $company (dict "slug" .File.BaseFileName) -}} {{- $companies =
$companies | append $company -}} {{- end -}} {{- end -}} {{- $companies = sort $companies
"name" -}} {{- $taxonomies := .Site.Data.taxonomies -}}

<div class="row directory-header">
  <nav aria-label="breadcrumb" class="col-8 col-m-6 col-s-12 directory-breadcrumb">
    <ul>
      <li>Directory</li>
      <li id="breadcrumb-filters" class="hidden">
        <button type="button" class="filter-badge" id="clear-filters">
          <span class="filter-count">0</span> filters ✕
        </button>
      </li>
      <li>
        {{/* aria-live announces count changes to screen readers */}}
        <output id="results-status" aria-live="polite" aria-atomic="true">
          <span class="visible-count">{{ len $companies }}</span> of {{ len $companies }}
        </output>
      </li>
    </ul>
  </nav>
  <div class="col-4 col-m-6 col-s-12">
    <fieldset role="group" class="search-group">
      <legend class="visually-hidden">Search and view options</legend>
      <input
        type="search"
        name="q"
        form="filters"
        placeholder="Search companies..."
        autocomplete="off"
        aria-label="Search companies"
      >
      <label class="map-toggle" title="Show map">
        <input type="checkbox" id="map-toggle" name="view" value="map" form="filters">
        {{ partial "icon.html" (dict "name" "map" "size" 20) }}
      </label>
    </fieldset>
  </div>
</div>

{{/* Skip link to bypass filters - visible on focus */}}
<a href="#company-grid" class="skip-link">Skip to results</a>

<h1 class="visually-hidden">
  WA Defence Industry and Science Capability Directory
</h1>

<div class="row" id="directory">
  <!-- Mobile filter toggle button -->
  <button type="button" class="mobile-filter-toggle" aria-expanded="false" aria-controls="filters-sidebar">
    {{ partial "icon.html" (dict "name" "filter" "size" 18) }}
    Filters
  </button>

  <!-- Main Content (first in DOM for better tab order: search → results) -->
  <section class="col-9 col-m-8 col-s-12 directory-results">
    <!-- Cards Grid -->
    <div class="grid-auto" id="company-grid" tabindex="-1">
      {{- range $companies }} {{ partial "company-card.html" (dict "company" .
      "computed" (index $computed .slug) "mode" "directory") }} {{- end }}
    </div>

    <!-- Map iframe (hidden by default) -->
    <iframe id="map-iframe" class="hidden" title="Map"></iframe>

    <!-- No results message -->
    <p class="no-results">No companies match your filters.</p>
  </section>
  
  <!-- Filters Sidebar (after results in DOM, positioned left via CSS) -->
  <aside class="col-3 col-m-4 col-s-12 filters-sidebar" id="filters-sidebar">
    <button type="button" class="mobile-filter-close" aria-label="Close filters">
      {{ partial "icon.html" (dict "name" "x" "size" 24) }}
    </button>
    <form class="filters" id="filters" method="get">
      {{ partial "filters.html" . }}
      <button type="submit" class="visually-hidden" id="filter-submit">Apply filters</button>
    </form>
  </aside>
  
  <!-- Mobile filter backdrop -->
  <div class="mobile-filter-backdrop"></div>
</div>

<noscript>
  <style>
    .no-results {
      display: none !important;
    }
  </style>
</noscript>

<script>
  (function() {
    "use strict";

    // === DOM ===
    const $ = (s) => document.querySelector(s);
    const $$ = (s) => [...document.querySelectorAll(s)];
    const form = $("#filters");
    const cards = $$(".company-item");
    const gridEl = $("#company-grid");
    const mapIframe = $("#map-iframe");
    const countEl = $(".visible-count");
    const filterCountEl = $(".filter-count");
    const breadcrumbFilters = $("#breadcrumb-filters");
    const noResults = $(".no-results");
    const mapToggle = $("#map-toggle");
    const totalCount = cards.length;

    let mapLoaded = false;
    let isSubmitting = false;

    // === Get Filters from URL ===
    function getFiltersFromURL() {
      const params = new URLSearchParams(location.search);
      return {
        search: (params.get("q") || "").trim().toLowerCase(),
        f: params.getAll("f"),
      };
    }

    // === Match Card Against Filters ===
    function matchesFilters(dataset, filters) {
      if (filters.search) {
        const text = (dataset.search || "").toLowerCase();
        if (!text.includes(filters.search)) return false;
      }

      if (filters.f.length) {
        const cardFilters = (dataset.f || "").toLowerCase().split("|");
        if (!filters.f.every(f => cardFilters.includes(f.toLowerCase()))) return false;
      }

      return true;
    }

    // === Handle Form Submit ===
    function handleFormSubmit(e) {
      e.preventDefault();

      if (isSubmitting) return;
      isSubmitting = true;

      const params = new URLSearchParams(new FormData(form));

      const url = params.toString() ? "?" + params : location.pathname;
      history.replaceState({}, "", url);

      updateCards();
      updateMap();

      isSubmitting = false;
    }

    form.addEventListener("submit", handleFormSubmit);

    // Checkbox changes trigger form submit (map toggle already handled by form submit)
    form.addEventListener("change", (e) => {
      if (e.target.type === "checkbox" && e.target.id !== "map-toggle") {
        form.dispatchEvent(new Event('submit'));
      }
    });

    // === Map Toggle ===
    function isMapView() {
      return mapToggle?.checked;
    }

    function setView(showMap) {
      gridEl.classList.toggle("hidden", showMap);
      mapIframe.classList.toggle("hidden", !showMap);

      if (showMap && !mapLoaded) {
        mapIframe.src = "./map/";
        mapLoaded = true;
      }

      showMap ? updateMap() : updateCards();
      if (showMap && noResults) noResults.style.display = "none";
    }

    mapToggle?.addEventListener("change", () => {
      setView(mapToggle.checked, true);
      form.dispatchEvent(new Event('submit'));
    });

    // Debounced search (auto-submit form)
    let searchTimeout;
    form.q?.addEventListener("input", () => {
      clearTimeout(searchTimeout);
      searchTimeout = setTimeout(() => {
        form.dispatchEvent(new Event('submit'));
      }, 150);
    });

    // === Search Highlighting ===
    function updateHighlight(query) {
      if (!CSS.highlights) return;
      CSS.highlights.clear();
      if (!query) return;

      const ranges = [];
      const q = query.toLowerCase();

      $$(".company-item:not(.filter-hidden) .name").forEach((el) => {
        const textNode = el.firstChild;
        if (!textNode || textNode.nodeType !== Node.TEXT_NODE) return;
        const text = textNode.textContent.toLowerCase();
        const idx = text.indexOf(q);
        if (idx >= 0) {
          try {
            const range = new Range();
            range.setStart(textNode, idx);
            range.setEnd(textNode, idx + q.length);
            ranges.push(range);
          } catch (e) {}
        }
      });

      if (ranges.length) CSS.highlights.set("search-results", new Highlight(...ranges));
    }

    // === Update Display ===
    function updateCards() {
      const filters = getFiltersFromURL();
      let visibleCount = 0;

      cards.forEach((card) => {
        const visible = matchesFilters(card.dataset, filters);
        card.classList.toggle("filter-hidden", !visible);
        if (visible) visibleCount++;
      });

      if (countEl) countEl.textContent = visibleCount;
      if (noResults && !isMapView()) {
        noResults.style.display = visibleCount === 0 ? "block" : "none";
      }

      const activeFilters = filters.f.length + (filters.search ? 1 : 0);
      if (breadcrumbFilters) {
        breadcrumbFilters.classList.toggle("hidden", activeFilters === 0);
        if (filterCountEl) filterCountEl.textContent = activeFilters;
      }

      updateHighlight(filters.search || "");
    }

    // === Map Communication ===
    function updateMap() {
      if (!isMapView() || !mapLoaded) return;
      const params = new URLSearchParams(location.search).toString();
      mapIframe.contentWindow?.postMessage({ type: "updateFilters", params }, "*");
    }

    window.addEventListener("message", (e) => {
      if (e.data?.type === "markerCount" && isMapView()) {
        if (countEl) countEl.textContent = e.data.count;
        if (noResults) noResults.style.display = e.data.count === 0 ? "block" : "none";
      }
    });

    // === Map Toggle ===
    function isMapView() {
      return mapToggle?.checked;
    }

    function setView(showMap) {
      gridEl.classList.toggle("hidden", showMap);
      mapIframe.classList.toggle("hidden", !showMap);

      if (showMap && !mapLoaded) {
        mapIframe.src = "./map/";
        mapLoaded = true;
      }

      showMap ? updateMap() : updateCards();
      if (showMap && noResults) noResults.style.display = "none";
    }

    mapIframe.addEventListener("load", updateMap);

    // === Handle Back/Forward Browser Navigation ===
    window.addEventListener("popstate", () => {
      // Browser already updated form from URL params
      updateCards();
      updateMap();
    });

    // === Mobile Filter Toggle (with focus trap for a11y) ===
    const filterToggle = $(".mobile-filter-toggle");
    const filterSidebar = $(".filters-sidebar");
    const filterBackdrop = $(".mobile-filter-backdrop");
    const filterClose = $(".mobile-filter-close");
    let previousActiveElement = null;

    function openFilters() {
      previousActiveElement = document.activeElement;
      filterSidebar?.classList.add("open");
      filterBackdrop?.classList.add("open");
      filterToggle?.setAttribute("aria-expanded", "true");
      document.body.style.overflow = "hidden";
      const firstFocusable = filterSidebar?.querySelector(
        'input, button, [tabindex]:not([tabindex="-1"])'
      );
      firstFocusable?.focus();
    }

    function closeFilters() {
      filterSidebar?.classList.remove("open");
      filterBackdrop?.classList.remove("open");
      filterToggle?.setAttribute("aria-expanded", "false");
      document.body.style.overflow = "";
      previousActiveElement?.focus();
    }

    filterToggle?.addEventListener("click", openFilters);
    filterClose?.addEventListener("click", closeFilters);
    filterBackdrop?.addEventListener("click", closeFilters);

    filterSidebar?.addEventListener("keydown", (e) => {
      if (e.key !== "Tab" || !filterSidebar.classList.contains("open")) return;
      const focusables = [...filterSidebar.querySelectorAll(
        'input:not([type="hidden"]), button, [tabindex]:not([tabindex="-1"])'
      )].filter(el => !el.hidden && !el.disabled);
      if (!focusables.length) return;
      const first = focusables[0];
      const last = focusables[focusables.length - 1];
      if (e.shiftKey && document.activeElement === first) {
        e.preventDefault();
        last.focus();
      } else if (!e.shiftKey && document.activeElement === last) {
        e.preventDefault();
        first.focus();
      }
    });

    // === Clear Filters Badge ===
    const clearFiltersBtn = $("#clear-filters");
    clearFiltersBtn?.addEventListener("click", () => {
      form.reset();
      form.dispatchEvent(new Event('submit'));
    });

    // === Keyboard Shortcuts (a11y) ===
    document.addEventListener("keydown", (e) => {
      if (e.key === "/" && !e.target.matches("input, textarea, select")) {
        e.preventDefault();
        form.q?.focus();
      }
      if (e.key === "Escape") {
        if (filterSidebar?.classList.contains("open")) {
          closeFilters();
        } else if (form.q?.value) {
          form.q.value = "";
          form.submit();
        }
      }
    });

    // === Init ===
    // Manually populate form from URL params to ensure checkboxes are checked
    const params = new URLSearchParams(location.search);
    const filterValues = params.getAll("f");

    // Update checkboxes from URL
    form.querySelectorAll('input[name="f"][type="checkbox"]').forEach(checkbox => {
      checkbox.checked = filterValues.includes(checkbox.value);
    });

    // Handle map toggle state
    if (mapToggle) {
      const initialMapState = params.get("view") === "map";
      if (initialMapState !== mapToggle.checked) {
        mapToggle.checked = initialMapState;
        setView(initialMapState, false);
      }
    }

    updateCards();
  })();
</script>

{{ end }}
