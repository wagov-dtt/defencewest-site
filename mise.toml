[tools]
python = "3.12"
uv = "latest"
hugo = "latest"
lychee = "latest"
"github:kristoff-it/superhtml" = "latest"
"github:boyter/scc" = "latest"

[env]
PYTHONDONTWRITEBYTECODE = "1"

[tasks.setup]
description = "Install Python dependencies and generate computed data"
run = ["uv sync", "mise run preprocess"]

[tasks.setup-ci]
description = "Install system dependencies for CI (mlnative runtime dependencies)"
run = """
sudo apt-get update && sudo apt-get install -y \
  mesa-vulkan-drivers \
  libcurl4 \
  libglfw3 \
  libuv1 \
  zlib1g
"""

[tasks.dev]
depends = ["preprocess"]
run = "hugo server -D --disableFastRender"

[tasks.build]
description = "Full build: preprocess, hugo, validate HTML, check links"
run = [
  "uv sync",
  "mise run preprocess",
  "hugo --cleanDestinationDir --printPathWarnings --printUnusedTemplates",
  "mise run htmlcheck",
  "mise run linkcheck",
]

[tasks.ci-build]
description = "CI build with GitHub annotations"
run = """
#!/bin/bash
set -o pipefail

# Run full build and capture output
mise run build 2>&1 | tee build.log
BUILD_EXIT=${PIPESTATUS[0]}

# Surface Hugo warnings as GitHub annotations
grep -E "^WARN" build.log | while read -r line; do echo "::warning::$line"; done || true

# Surface Hugo errors as GitHub annotations  
if grep -q "^ERROR" build.log; then
  grep "^ERROR" build.log | while read -r line; do echo "::error::$line"; done
  exit 1
fi

# Create annotation for link errors
if grep -q "ðŸš«" build.log; then
  ERROR_COUNT=$(grep -oP 'ðŸš« Errors\\s*\\|\\s*\\K\\d+' build.log || echo "unknown")
  echo "::warning::Link check found $ERROR_COUNT broken links (external sites we don't control)"
fi

exit $BUILD_EXIT
"""

[tasks.preprocess]
run = "uv run python scripts/preprocess.py"

[tasks.linkcheck]
description = "Check links with lychee (warnings only)"
run = "lychee public/ --no-progress --format markdown --accept '200..=299, 301, 302, 403' --cache --max-cache-age 7d || true"

[tasks.htmlcheck]
description = "Check HTML validity with superhtml"
run = "find public -name '*.html' | xargs superhtml check"

[tasks.scrape]
run = "uv run python scripts/scrape.py"

[tasks.scrape-fresh]
run = "uv run python scripts/scrape.py --fresh"

[tasks.scc]
description = "Count lines of code with SCC"
run = "scc --exclude-dir data,content --format table"

[tasks.a11ycheck]
description = "Run accessibility tests (CI only - requires pnpm install + Chromium)"
run = "pnpm exec pa11y-ci"
